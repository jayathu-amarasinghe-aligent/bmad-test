name: Image Pipeline (Full)

# This workflow handles the complete image pipeline:
# 1. Extract EXIF metadata
# 2. Optimize images (future)
# 3. Generate metadata JSON
# 4. Commit changes
# 5. Trigger Vercel deployment

on:
  # Trigger on image changes
  push:
    branches:
      - main
    paths:
      - 'public/images/**/*'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate all metadata'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  image-pipeline:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸ” Count images
        id: count-images
        run: |
          COLOR_COUNT=$(find public/images/color -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) 2>/dev/null | wc -l || echo 0)
          BW_COUNT=$(find public/images/bw -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) 2>/dev/null | wc -l || echo 0)
          TOTAL=$((COLOR_COUNT + BW_COUNT))
          echo "color=$COLOR_COUNT" >> $GITHUB_OUTPUT
          echo "bw=$BW_COUNT" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "ğŸ“¸ Found $TOTAL images ($COLOR_COUNT color, $BW_COUNT B&W)"

      - name: ğŸ¨ Generate image metadata
        run: |
          echo "ğŸ” Extracting EXIF metadata from images..."
          npm run generate-metadata

      - name: ğŸ“Š Display metadata stats
        run: |
          if [ -f public/data/images.json ]; then
            echo "âœ… Metadata generated successfully"
            cat public/data/images.json | head -n 20
          else
            echo "âš ï¸ No metadata file generated"
          fi

      - name: ğŸ” Check for changes
        id: git-check
        run: |
          git add public/data/images.json
          if git diff --cached --quiet public/data/images.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to metadata"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ¨ Metadata updated"
          fi

      - name: ğŸ“ Commit metadata changes
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add public/data/images.json
          git commit -m "ğŸ¤– Auto-update image metadata

          - Extracted EXIF data from ${{ steps.count-images.outputs.total }} images
          - Color images: ${{ steps.count-images.outputs.color }}
          - B&W images: ${{ steps.count-images.outputs.bw }}

          Generated by image-pipeline workflow

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"

      - name: ğŸš€ Push changes
        if: steps.git-check.outputs.changed == 'true'
        run: git push

      - name: ğŸ“‹ Workflow summary (Updated)
        if: steps.git-check.outputs.changed == 'true'
        run: |
          echo "## âœ… Image Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Images:** ${{ steps.count-images.outputs.total }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Color Gallery:** ${{ steps.count-images.outputs.color }} images" >> $GITHUB_STEP_SUMMARY
          echo "- **B&W Gallery:** ${{ steps.count-images.outputs.bw }} images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Actions Taken" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Extracted EXIF metadata (ISO, aperture, shutter, camera, lens)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Generated \`public/data/images.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Committed changes to repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ Manual Actions Needed" >> $GITHUB_STEP_SUMMARY
          echo "Edit \`public/data/images.json\` to add:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ Location names (e.g., 'Serengeti National Park, Tanzania')" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“– Behind-the-lens stories" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ… Time of day tags (dawn/midday/dusk/night)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "Vercel will automatically deploy the updated site with new images." >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“‹ Workflow summary (No changes)
        if: steps.git-check.outputs.changed != 'true'
        run: |
          echo "## â„¹ï¸ No Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image metadata is already up to date." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Current Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Images:** ${{ steps.count-images.outputs.total }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Color Gallery:** ${{ steps.count-images.outputs.color }} images" >> $GITHUB_STEP_SUMMARY
          echo "- **B&W Gallery:** ${{ steps.count-images.outputs.bw }} images" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Pipeline failed
        if: failure()
        run: |
          echo "## âŒ Image Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The image metadata extraction failed. Please check the workflow logs." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Common Issues:" >> $GITHUB_STEP_SUMMARY
          echo "- Corrupt image files" >> $GITHUB_STEP_SUMMARY
          echo "- Missing EXIF data" >> $GITHUB_STEP_SUMMARY
          echo "- File permission errors" >> $GITHUB_STEP_SUMMARY
